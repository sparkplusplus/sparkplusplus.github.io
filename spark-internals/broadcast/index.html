<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-spark-internals/broadcast">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Broadcast | SparkPlusPlus</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://sparkplusplus.github.io/spark-internals/broadcast"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Broadcast | SparkPlusPlus"><meta data-rh="true" name="description" content="Prophecy deployment is flexible and supports multiple mechanisms"><meta data-rh="true" property="og:description" content="Prophecy deployment is flexible and supports multiple mechanisms"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://sparkplusplus.github.io/spark-internals/broadcast"><link data-rh="true" rel="alternate" href="https://sparkplusplus.github.io/spark-internals/broadcast" hreflang="en"><link data-rh="true" rel="alternate" href="https://sparkplusplus.github.io/spark-internals/broadcast" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ZWUSSL-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="SparkPlusPlus" href="/opensearch.xml">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="/assets/css/styles.b22f5b3f.css">
<link rel="preload" href="/assets/js/runtime~main.3b17f140.js" as="script">
<link rel="preload" href="/assets/js/main.ed3b454b.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Logo.png" alt="SparkPlusPlus Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/Logo.png" alt="SparkPlusPlus Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a href="https://github.com/sparkplusplus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Home</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Spark Internals</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/spark-internals/">Spark Internals</a><button aria-label="Toggle the collapsible sidebar category &#x27;Spark Internals&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/spark-internals/plans/spark-logical-plan">Spark Planning</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/shuffle-details">Shuffle Details</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/cache-and-checkpoint">Cache And Checkpoint</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/spark-internals/broadcast">Broadcast</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/spark-internals/"><span itemprop="name">Spark Internals</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Broadcast</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Broadcast</h1></header><p>As its name implies, broadcast means sending data from one node to all other nodes in the cluster. It&#x27;s useful in many situations, for example we have a table in the driver, and other nodes need it as a lookup table. With broadcast we can send this table to all nodes and tasks will be able to do local lookups. Actually, it is challenging to implement a broadcast mechanism that is reliable and efficient. Spark&#x27;s documentation says:</p><blockquote><p>Broadcast variables allow the programmer to keep a <strong>read-only</strong> variable cached on each <strong>machine</strong> rather than shipping a copy of it with <strong>tasks</strong>. They can be used, for example, to give every node a copy of a <strong>large input dataset</strong> in an efficient manner. Spark also attempts to distribute broadcast variables using <strong>efficient</strong> broadcast algorithms to reduce communication cost.</p></blockquote><h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-read-only">Why read-only?<a href="#why-read-only" class="hash-link" aria-label="Direct link to Why read-only?" title="Direct link to Why read-only?">​</a></h3><p>This is a consistency problem. If a broadcasted variable can be mutated, once it&#x27;s modified in some node, should we also update the copies on other nodes? If multiple nodes have updated their copies, how do we determine an order to synchronize these independent updates? There&#x27;s also fault-tolerance problem coming in. To avoid all these tricky problems with data consistency, Spark only supports read-only broadcast variables.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="why-broadcast-to-nodes-but-not-tasks">Why broadcast to nodes but not tasks?<a href="#why-broadcast-to-nodes-but-not-tasks" class="hash-link" aria-label="Direct link to Why broadcast to nodes but not tasks?" title="Direct link to Why broadcast to nodes but not tasks?">​</a></h3><p>Each task runs inside a thread, and all tasks in a process belong to the same Spark application. So a single read-only copy in each node (executor) can be shared by all tasks.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-to-use-broadcast">How to use broadcast?<a href="#how-to-use-broadcast" class="hash-link" aria-label="Direct link to How to use broadcast?" title="Direct link to How to use broadcast?">​</a></h3><p>An example of a driver program:</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> data </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> bdata </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">broadcast</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> rdd </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parallelize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token plain"> to </span><span class="token number" style="color:#36acaa">6</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> observedSizes </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rdd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">_ </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> bdata</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Driver uses <code>sc.broadcast()</code> to declare the data to broadcast. The type of <code>bdata</code> is <code>Broadcast</code>. <code>rdd.transformation(func)</code> uses <code>bdata</code> directly inside its function like a local variable.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="how-is-broadcast-implemented">How is broadcast implemented?<a href="#how-is-broadcast-implemented" class="hash-link" aria-label="Direct link to How is broadcast implemented?" title="Direct link to How is broadcast implemented?">​</a></h3><p>The implementation behind the broadcast feature is quite interesting.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="distribute-metadata-of-the-broadcast-variable">Distribute metadata of the broadcast variable<a href="#distribute-metadata-of-the-broadcast-variable" class="hash-link" aria-label="Direct link to Distribute metadata of the broadcast variable" title="Direct link to Distribute metadata of the broadcast variable">​</a></h4><p>Driver creates a local directory to store the data to be broadcasted and launches a <code>HttpServer</code> with access to the directory. The data is actually written into the directory when the broadcast is called (<code>val bdata = sc.broadcast(data)</code>). At the same time, the data is also written into driver&#x27;s <code>blockManger</code> with a <code>StorageLevel</code> memory + disk. Block manager allocates a <code>blockId</code> (of type <code>BroadcastBlockId</code>) for the data. When a transformation function uses the broadcasted variable, the driver&#x27;s <code>submitTask()</code> will serialize its metadata and send it along with the serialized function to all nodes. Akka system impose message size limits so we can not use it to broadcast the actual data.</p><blockquote><p>Why driver put the data in both local disk directory and block manager? The copy on the local disk directory is for the HttpServer, and the copy in block manager is to facilitate the usage of this data inside the driver program.</p></blockquote><p><strong>Then when the real data is broadcasted?</strong> When an executor deserializes the task it has received, it also gets the broadcast variable&#x27;s metadata, in the form of a <code>Broadcast</code> object. It then calls the <code>readObject()</code> method of the metadata object (<code>bdata</code> variable). This method will first check the local block manager to see if there&#x27;s already a local copy. If not, the data will be fetched from the driver. Once the data is fetched, it&#x27;s stored in the local block manager for subsequent uses.</p><p>Spark has actually 2 different implementations of the data fetching.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="httpbroadcast">HttpBroadcast<a href="#httpbroadcast" class="hash-link" aria-label="Direct link to HttpBroadcast" title="Direct link to HttpBroadcast">​</a></h4><p>This method fetches data through an http connection between the executor and the driver.</p><p>Driver creates a <code>HttpBroadcast</code> object and it&#x27;s this object&#x27;s job to store the broadcast data into the driver&#x27;s block manager. In the same time, as we described earlier, the data is written on the local disk, for example in a directory named <code>/var/folders/87/grpn1_fn4xq5wdqmxk31v0l00000gp/T/spark-6233b09c-3c72-4a4d-832b-6c0791d0eb9c/broadcast_0</code>.</p><blockquote><p>Driver and executor instantiate a <code>broadcastManger</code> object during initialization. The local directory is created by <code>HttpBroadcast.initialize()</code> method. This method also launches the http server.</p></blockquote><p>The actual fetching is just data transmission between two nodes with an http connection.</p><p>The problem of <code>HttpBroadcast</code> is network bandwidth bottleneck in the driver node since it sends data to all other worker nodes at the same time.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="torrentbroadcast">TorrentBroadcast<a href="#torrentbroadcast" class="hash-link" aria-label="Direct link to TorrentBroadcast" title="Direct link to TorrentBroadcast">​</a></h4><p>To solve the driver network bottleneck problem in <code>HttpBroadcast</code>, Spark introduced a new broadcast implementation called <code>TorrentBroadcast</code> which is inspired by BitTorrent. The basic concept of this method is to cut the broadcast data in blocks, and executors who have already fetched data blocks can themselves be the data source.</p><p>Unlike the data transfer in <code>HttpBroadcast</code>, <code>TorrentBroadcast</code> uses <code>blockManager.getRemote() =&gt; NIO ConnectionManager</code> to do the job. The actual sending and receiving process is quite similar with the cached rdd that we&#x27;ve talked about in the last chapter (check last diagram in <a href="https://github.com/JerryLead/SparkInternals/blob/master/markdown/6-CacheAndCheckpoint.md" target="_blank" rel="noopener noreferrer">CacheAndCheckpoint</a>.</p><p>Let&#x27;s see some details in <code>TorrentBroadcast</code>:</p><p><img loading="lazy" alt="TorrentBroadcast" src="/assets/images/TorrentBroadcast-e9b8c8c04c6c8421655c3e0b429f45d4.png" width="602" height="276" class="img_ev3q"></p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="driver">Driver<a href="#driver" class="hash-link" aria-label="Direct link to Driver" title="Direct link to Driver">​</a></h4><p>The driver serializes the data into <code>ByteArray</code> and then cut it into <code>BLOCK_SIZE</code> (defined by <code>spark.broadcast.blockSize = 4MB</code>) blocks. After the cut the original <code>ByteArray</code> will be collected but there&#x27;s a temporary moment we have 2 copies of the data in memory.</p><p>After the cut, information about the blocks (called metadata) is stored in driver&#x27;s block manager with a storage level at memory + disk. At this time, driver&#x27;s <code>blockManagerMaster</code> will also be informed that the metadata is successfully stored. <strong>This is an important step because blockManagerMaster can be accessed by all executors, meaning that block metadata has now become global data of the cluster.</strong></p><p>Driver then finishes its work by physically storing the data blocks under its block manager.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="executor">Executor<a href="#executor" class="hash-link" aria-label="Direct link to Executor" title="Direct link to Executor">​</a></h4><p>Upon receiving a serialized task, an executor deserializes it first. The deserialization also includes the broadcast metadata, whose type is <code>TorrentBroadcast</code>. Then its <code>TorrentBroadcast.readObject()</code> method is called. Similar to the general steps illustrated above, the local block manager will be checked first to see if some data blocks have already been fetched. If not, executor will ask driver&#x27;s <code>blockManagerMaster</code> for the data block&#x27;s metadata. Then the BitTorrent process starts to fetch the data blocks.</p><p><strong>BitTorrent process:</strong> an <code>arrayOfBlocks = new Array[TorrentBlock](totalBlocks)</code> is allocated locally to store the fetched data. <code>TorrentBlock</code> is a wrapper over a data block. The actual fetching order is randomized. For example if there&#x27;s 5 blocks to fetch in total, the fetching order may be 3-1-2-4-5. Then the executor starts to fetch the data block one by one: local <code>blockManager</code> =&gt; local <code>connectionManager</code> =&gt; driver/other executor&#x27;s blockManager =&gt; data. <strong>Each fetched block is stored under local block manager and driver&#x27;s <code>blockManagerMaster</code> is informed that this block has been successfully fetched.</strong> As you&#x27;ll guess, this is an important step because now all other nodes in the cluster know that there&#x27;s a new data source for this block. If another node starts to fetch the same block, it&#x27;ll randomly choose one data source. With more and more blocks being fetched, we&#x27;ll have more data sources and the whole broadcast will be accelerated. There&#x27;s a good illustration about BitTorrent on <a href="http://zh.wikipedia.org/wiki/BitTorrent_(%E5%8D%8F%E8%AE%AE)" target="_blank" rel="noopener noreferrer">wikipedia</a>.</p><p>When all the data blocks are fetched locally, a big <code>Array[Byte]</code> will be allocated to reconstitute the original broadcast data from blocks. Finally this array gets deserialized and is stored under local block manager. Notice that once we have the broadcast variable in local block manager, we can safely delete the fetched data blocks (which are also stored in local block manager).</p><p>One more question: what about broadcasting an RDD? In fact nothing bad will happen. This RDD will be evaluated in each executor so that each node has a copy of its result.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="discussion">Discussion<a href="#discussion" class="hash-link" aria-label="Direct link to Discussion" title="Direct link to Discussion">​</a></h2><p>Broadcasting shared variables is a very handy feature. In Hadoop we have the <code>DistributedCache</code> and it&#x27;s used in many situations. For example, parameters of <code>-libjars</code> are sent to all nodes by using <code>DistributedCache</code>. However in Hadoop broadcasted data needs to be uploaded to HDFS first and it has no mechanism to share data between tasks in the same node. Say if some node needs to process 4 mappers coming from the same job, then the broadcast variable will be stored 4 times in this node (one copy in each mapper&#x27;s working directory). An advantage of this approach is that by using HDFS we won&#x27;t have the bottleneck problem since HDFS does the job of cutting data into blocks and distributing them across the cluster.</p><p>For Spark, broadcast cares about sending data to all nodes as well as letting tasks of the same node share data. Spark&#x27;s block manager solves the problem of sharing data between tasks in the same node. Storing shared data in local block manager with a storage level at memory + disk guarantees that all local tasks can access the shared data, in this way we avoid storing multiple copies. Spark has 2 broadcast implementations. The traditional <code>HttpBroadcast</code> has the bottleneck problem around the driver node. <code>TorrentBroadcast</code> solves this problem but it starts slower since it only accelerate the broadcast after some amount of blocks fetched by executors. Also in Spark, the reconstitution of original data from data blocks needs some extra memory space.</p><p>In fact Spark also tried an alternative called <code>TreeBroadcast</code>. Interested reader can check the technical report: <a href="http://www.cs.berkeley.edu/~agearh/cs267.sp10/files/mosharaf-spark-bc-report-spring10.pdf" target="_blank" rel="noopener noreferrer">Performance and Scalability of Broadcast in Spark</a>.</p><p>In my opinion the broadcast feature can even be implemented by using multicast protocols. But multicast is UDP based, we&#x27;ll need mechanisms on reliability in the application layer.</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/overview">overview</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/spark-internals">spark-internals</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/spark-internals/cache-and-checkpoint"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Cache And Checkpoint</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#why-read-only" class="table-of-contents__link toc-highlight">Why read-only?</a></li><li><a href="#why-broadcast-to-nodes-but-not-tasks" class="table-of-contents__link toc-highlight">Why broadcast to nodes but not tasks?</a></li><li><a href="#how-to-use-broadcast" class="table-of-contents__link toc-highlight">How to use broadcast?</a></li><li><a href="#how-is-broadcast-implemented" class="table-of-contents__link toc-highlight">How is broadcast implemented?</a></li><li><a href="#discussion" class="table-of-contents__link toc-highlight">Discussion</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://join.slack.com/t/sparkplusplus/shared_invite/zt-2ceryo2v8-rb6m5M0Bqq02n_KKjP6CvQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">Join our Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/sparkplusplus/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2024 SparkPlusPlus Inc All Rights Reserved target="_blank">Privacy Policy</div></div></div></footer></div>
<script src="/assets/js/runtime~main.3b17f140.js"></script>
<script src="/assets/js/main.ed3b454b.js"></script>
</body>
</html>