<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-spark-internals/plans/spark-physical-plan">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Spark Physical Plan | SparkPlusPlus</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://sparkplusplus.github.io/spark-internals/plans/spark-physical-plan"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Spark Physical Plan | SparkPlusPlus"><meta data-rh="true" name="description" content="Prophecy deployment is flexible and supports multiple mechanisms"><meta data-rh="true" property="og:description" content="Prophecy deployment is flexible and supports multiple mechanisms"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://sparkplusplus.github.io/spark-internals/plans/spark-physical-plan"><link data-rh="true" rel="alternate" href="https://sparkplusplus.github.io/spark-internals/plans/spark-physical-plan" hreflang="en"><link data-rh="true" rel="alternate" href="https://sparkplusplus.github.io/spark-internals/plans/spark-physical-plan" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://P8WC4Z2QXP-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="SparkPlusPlus" href="/opensearch.xml">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="/assets/css/styles.b22f5b3f.css">
<link rel="preload" href="/assets/js/runtime~main.3b17f140.js" as="script">
<link rel="preload" href="/assets/js/main.7e55bda0.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Logo.png" alt="SparkPlusPlus Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/Logo.png" alt="SparkPlusPlus Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a href="https://github.com/sparkplusplus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Home</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Spark Internals</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/spark-internals/">Spark Internals</a><button aria-label="Toggle the collapsible sidebar category &#x27;Spark Internals&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/spark-internals/plans/spark-logical-plan">Spark Planning</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/plans/spark-logical-plan">Spark Logical Plan</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/spark-internals/plans/spark-physical-plan">Spark Physical Plan</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/shuffle-details">Shuffle Details</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/cache-and-checkpoint">Cache And Checkpoint</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/broadcast">Broadcast</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/spark-internals/"><span itemprop="name">Spark Internals</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Spark Planning</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Spark Physical Plan</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Physical Plan</h1><p>We have briefly introduced the DAG-like physical plan, which contains stages and tasks. In this chapter, we&#x27;ll look at <strong>how the physical plan (so the stages and tasks) is generated given a logical plan of a Spark application.</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-complex-logical-plan">A Complex Logical Plan<a href="#a-complex-logical-plan" class="hash-link" aria-label="Direct link to A Complex Logical Plan" title="Direct link to A Complex Logical Plan">​</a></h2><p><img loading="lazy" alt="ComplexJob" src="/assets/images/ComplexJob-2f0e7e40d78e11e98565a2d6b1f55b76.png" width="1654" height="1337" class="img_ev3q">
The code of this application is attached at the end of this chapter.</p><p><strong>How to properly define stages and determine the tasks with such a complex data dependency graph?</strong></p><p>An intuitive idea is to associate one RDD and its preceding RDD to form a stage, in this way each arrow in the above graph will become a task. For the case of 2 RDDs aggregates into one, we may create a stage with these 3 RDDs. This strategy could be a working solution, but will not be efficient. It has a subtle, but severe problem: <strong>lots of intermediate data needs to be stored</strong>. For a physical task, its result will be stored either on local disk, or in the memory, or both. If a task is generated for each arrow in the data dependency graph, the system needs to store data of all the RDDs. It will cost a lot.</p><p>If we examine the logical plan more closely, we may find out that in each RDD, the partitions are independent from each other. That is to say, inside each RDD, the data within a partition will not interfere others. With this observation, an aggressive idea is to consider the whole diagram as a single stage and create one physical task for each partition of the final RDD (<code>FlatMappedValuesRDD</code>). The following diagram illustrates this idea:</p><p><img loading="lazy" alt="ComplexTask" src="/assets/images/ComplexTask-14bdde48057aae397cbb414533744c2d.png" width="807" height="649" class="img_ev3q"></p><p>All thick arrows in above diagram belong to task1 whose result is the first partition of the final RDD of the job. Note that in order to compute the first partition of the <code>CoGroupedRDD</code>, we need to evaluate all partitions of its preceding RDDs since it&#x27;s a <code>ShuffleDependency</code>. So in the computation of task1, we can also take the chance to compute the <code>CoGroupedRDD</code>&#x27;s second and third partition, for task2 and task3 respecively. As a result, the task2 and task3 are simpler. They are represented by thin arrows and dashed arrows in the diagram.</p><p>However, there&#x27;s 2 problems with this idea:</p><ul><li>The first task is big. Because of the <code>ShuffleDependency</code>, we have to evaluate all the partitions of the preceding RDDs.</li><li>Need to design clever algorithms to determine which are the partitions to cache.</li></ul><p>But there&#x27;s also one good point in this idea, that is to <strong>pipeline the data: the data is computed when they are actually needed in a flow fashion</strong>. For example in the first task, we check backwards from the final RDD (<code>FlatMappedValuesRDD</code>) to see which are the RDDs and partitions that are actually needed to be evaluated. And between the RDDs with <code>NarrowDependency</code> relation, no intermediate data needs to be stored.</p><p>It will be clearer to understand the pipelining if we consider a record-level point of view. The following diagram illustrates different evaluation patterns for RDDs with <code>NarrowDependency</code>.</p><p><img loading="lazy" alt="Dependency" src="/assets/images/pipeline-8581c5315e9958c46672fd71fc23706c.png" width="1622" height="1054" class="img_ev3q"></p><p>The first pattern (pipeline pattern) is equivalent to:</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">record </span><span class="token keyword" style="color:#00009f">&lt;-</span><span class="token plain"> records</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  f</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">g</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">record</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Consider <code>records</code> as a stream, we can see that no intermediate result need to be stored.Once the computation <code>f(g(record))</code> is done, the result will be stored and the record line could be garbarge collected. But for other patterns, for example the third pattern, this is not the case:</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">record </span><span class="token keyword" style="color:#00009f">&lt;-</span><span class="token plain"> records</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> fResult </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> f</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">record</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  store</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fResult</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// need to store the intermediate result here</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">record </span><span class="token keyword" style="color:#00009f">&lt;-</span><span class="token plain"> fResult</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  g</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">record</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>It&#x27;s clear that <code>f</code>&#x27;s result need to be stored somewhere.</p><p>Let&#x27;s go back to our problem with stages and tasks. The main issue of our aggressive idea is that we can&#x27;t actually pipelines then data flow if there&#x27;s a <code>ShuffleDependency</code>. Then how about to cut the data flow at each <code>ShuffleDependency</code>? That leaves us with chains of RDDs connected by <code>NarrowDependency</code> and we know that <code>NarrowDependency</code> can be pipelined. So we can just divide the logical plan into stages like this:</p><p><img loading="lazy" alt="ComplextStage" src="/assets/images/ComplexJobStage-60f5c8de0ec6d135e77aebd72c0c9c77.png" width="1754" height="1449" class="img_ev3q"></p><p>The strategy for creating stages is to: <strong>check backwards from the final RDD, add each <code>NarrowDependency</code> into the current stage and break out for a new stage when there&#x27;s a <code>ShuffleDependency</code>. In each stage, the task number is determined by the partition number of the last RDD in the stage.</strong></p><p>In above diagram, all thick arrows represent tasks. Since the stages are determined backwards, the last stage&#x27;s id is 0, stage 1 and stage 2 are both parents of stage 0. <strong>If a stage gives the final result, then its tasks are of type <code>ResultTask</code>, otherwise they are <code>ShuffleMapTask</code>.</strong> <code>ShuffleMapTask</code> gets its name because its result needs to be shuffled before goes into the next stage, it&#x27;s similar to the mappers in Hadoop MapReduce. <code>ResultTask</code> can be seen as reducer in Hadoop (if it gets shuffled data from its parent stage), or it could be mapper (if the stage has no parent).</p><p>One problem remains: <code>NarrowDependency</code> chain can be pipelined, but in our example application, we&#x27;ve showed only <code>OneToOneDependency</code> and <code>RangeDependency</code>, how about other <code>NarrowDependency</code>?</p><p>Let&#x27;s check back the cartesian operation in the last chapter with complex <code>NarrowDependency</code> inside:</p><p><img loading="lazy" alt="cartesian" src="/assets/images/Cartesian-903663465d2599b8ffbf7e0d0f55480b.png" width="3179" height="1783" class="img_ev3q"></p><p>With stages:</p><p><img loading="lazy" alt="cartesian" src="/assets/images/cartesianPipeline-a55ab11766e55c127b7c29b41a3bcec7.png" width="643" height="463" class="img_ev3q"></p><p>The thick arrows represents the first <code>ResultTask</code>. Since the stage gives directly the final result, in above diagram we have 6 <code>ResultTask</code>. Different with <code>OneToOneDependency</code>, each <code>ResultTask</code> in this job needs to evaluate 3 RDDs and read 2 data blocks, all executed in one single task. <strong>We can see that regardless of the actual type of <code>NarrowDependency</code>, be it 1:1 or N:N, <code>NarrowDependency</code> chain can always be pipelined. The number of task needed is the same as the partition number in the final RDD.</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="execution-of-the-physical-plan">Execution of the Physical Plan<a href="#execution-of-the-physical-plan" class="hash-link" aria-label="Direct link to Execution of the Physical Plan" title="Direct link to Execution of the Physical Plan">​</a></h2><p>We have stages and tasks, next problem: <strong>how the tasks are executed for the final result?</strong></p><p>Let&#x27;s go back to the physical plan of our example application of the chapter. Recall that in Hadoop MapReduce, the tasks are executed in order, <code>map()</code> generates map outputs, which in term gets partitioned and written to local disk. Then <code>shuffle-sort-aggregate</code> process is applied to generate reduce inputs. Finally <code>reduce()</code> executes for the final result. This process is illustrated in the following diagram:</p><p><img loading="lazy" alt="MapReduce" src="/assets/images/MapReduce-173f545b2c643aca876a7bb12951f061.png" width="488" height="245" class="img_ev3q"></p><p>This execution process can not be used directly on Spark&#x27;s physical plan since Hadoop MapReduce&#x27;s physical plan is simple and fixed, and without pipelining.</p><p>The main idea of pipelining is that <strong>the data is computed when they are actually needed in a flow fashion.</strong> We start from the final result (this is obviously where the computation is needed) and check backwards the RDD chain to find what are the RDDs and partitions that need to be evaluated for computing the final result. In most cases, we trace back to some partitions in the leftmost RDD and they are the first to be evaluated.</p><p><strong>For a stage without parent, its leftmost RDD can be evaluate directly (it has no dependency), and each record evaluated can be streamed into the subsequent computations (pipelining).</strong> The computation chain is deduced backwards from the final step, but the actual execution streams the records forwards. One record goes through the whole computation chain before the computation of the next record starts.</p><p>For stages with parent, we need to execute its parent stages and fetch the data through shuffle. Once it&#x27;s done, it becomes the same case as a stage without parent.</p><blockquote><p>In the code, each RDD&#x27;s <code>getDependency()</code> method declares its data dependency. <code>compute()</code> method is in charge of receiving upstream records (from parent RDD or data source) and applying computation logic. We see often code like this in RDDs: <code>firstParent[T].iterator(split, context).map(f)</code>. <code>firstParent</code> is the first dependent RDD, <code>iterator()</code> shows that the records are consumed one by one, and <code>map(f)</code> applies the computation logic on each record. The <code>compute()</code> method returns an iterator for next computation.</p></blockquote><p>Summary so far: <strong>The whole computation chain is created by checking backwards the data depency from the last RDD. Each <code>ShuffleDependency</code> separates stages. In each stage, each RDD&#x27;s <code>compute()</code> method calls <code>parentRDD.itererator()</code> to receive the upstream record stream.</strong></p><p>Notice that <code>compute()</code> method is reserved only for computation logic that generates output records from parent RDDs. The actual dependent RDDs are declared in <code>getDependency()</code> method. The actual dependent partitions are declared in <code>dependency.getParents()</code> method.</p><p>Let&#x27;s check the <code>CartesianRDD</code> as an example:</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// RDD x is the cartesian product of RDD a and RDD b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// RDD x = (RDD a).cartesian(RDD b)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">// Defines how many partitions RDD x should have, what are the types for each partition</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> </span><span class="token keyword" style="color:#00009f">override</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> getPartitions</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Partition</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// create the cross product split</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> array </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Partition</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rdd1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">partitions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> rdd2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">partitions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">s1 </span><span class="token keyword" style="color:#00009f">&lt;-</span><span class="token plain"> rdd1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">partitions</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> s2 </span><span class="token keyword" style="color:#00009f">&lt;-</span><span class="token plain"> rdd2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">partitions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> idx </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> s1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">index </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> numPartitionsInRdd2 </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> s2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">index</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      array</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">idx</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> CartesianPartition</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">idx</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rdd1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rdd2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> s2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    array</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Defines the computation logic for each partition of RDD x (the result RDD)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">override</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> compute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">split</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Partition</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> TaskContext</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> currSplit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> split</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">asInstanceOf</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">CartesianPartition</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// s1 shows that a partition in RDD x depends on one partition in RDD a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// s2 shows that a partition in RDD x depends on one partition in RDD b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">for</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token keyword" style="color:#00009f">&lt;-</span><span class="token plain"> rdd1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">iterator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">currSplit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">s1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">         y </span><span class="token keyword" style="color:#00009f">&lt;-</span><span class="token plain"> rdd2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">iterator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">currSplit</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">s2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">yield</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> y</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// Defines which are the dependent partitions and RDDs for partition i in RDD x</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// RDD x depends on RDD a and RDD b, both in `NarrowDependency`</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// For the first dependency, partition i in RDD x depends on the partition with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//     index `i / numPartitionsInRDD2` in RDD a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// For the second dependency, partition i in RDD x depends on the partition with</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">//     index `i % numPartitionsInRDD2` in RDD b</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">override</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> getDependencies</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Seq</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">Dependency</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">_</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> NarrowDependency</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rdd1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> getParents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Seq</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">Int</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">/</span><span class="token plain"> numPartitionsInRdd2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> NarrowDependency</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rdd2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> getParents</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token builtin">Int</span><span class="token punctuation" style="color:#393A34">)</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Seq</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">Int</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> List</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">%</span><span class="token plain"> numPartitionsInRdd2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="job-creation">Job Creation<a href="#job-creation" class="hash-link" aria-label="Direct link to Job Creation" title="Direct link to Job Creation">​</a></h2><p>Now we&#x27;ve introduced the logical plan and physical plan, then <strong>how and when a job is created? What exactly is a job?</strong></p><p>The following table shows the typical <a href="http://spark.apache.org/docs/latest/programming-guide.html#actions" target="_blank" rel="noopener noreferrer">action()</a>. The second column is <code>processPartition()</code> method, it defines how to process the records in each partition for the result. The third column is <code>resultHandler()</code> method, it defines how to process the partial results from each partition to form the final result.</p><table><thead><tr><th align="left">Action</th><th align="left">finalRDD(records) =&gt; result</th><th align="left">compute(results)</th></tr></thead><tbody><tr><td align="left">reduce(func)</td><td align="left">(record1, record2) =&gt; result, (result, record i) =&gt; result</td><td align="left">(result1, result 2) =&gt; result, (result, result i) =&gt; result</td></tr><tr><td align="left">collect()</td><td align="left">Array<!-- -->[records]<!-- --> =&gt; result</td><td align="left">Array<!-- -->[result]</td></tr><tr><td align="left">count()</td><td align="left">count(records) =&gt; result</td><td align="left">sum(result)</td></tr><tr><td align="left">foreach(f)</td><td align="left">f(records) =&gt; result</td><td align="left">Array<!-- -->[result]</td></tr><tr><td align="left">take(n)</td><td align="left">record (i&lt;=n) =&gt; result</td><td align="left">Array<!-- -->[result]</td></tr><tr><td align="left">first()</td><td align="left">record 1 =&gt; result</td><td align="left">Array<!-- -->[result]</td></tr><tr><td align="left">takeSample()</td><td align="left">selected records =&gt; result</td><td align="left">Array<!-- -->[result]</td></tr><tr><td align="left">takeOrdered(n, <!-- -->[ordering]<!-- -->)</td><td align="left">TopN(records) =&gt; result</td><td align="left">TopN(results)</td></tr><tr><td align="left">saveAsHadoopFile(path)</td><td align="left">records =&gt; write(records)</td><td align="left">null</td></tr><tr><td align="left">countByKey()</td><td align="left">(K, V) =&gt; Map(K, count(K))</td><td align="left">(Map, Map) =&gt; Map(K, count(K))</td></tr></tbody></table><p>Each time there&#x27;s an <code>action()</code> in user&#x27;s driver program, a job will be created. For example <code>foreach()</code> action will call <code>sc.runJob(this, (iter: Iterator[T]) =&gt; iter.foreach(f)))</code> to submit a job to the <code>DAGScheduler</code>. If there&#x27;s other <code>action()</code>s in the driver program, there will be other jobs submitted. So we&#x27;ll have as many jobs as the <code>action()</code> operations in a driver program. This is why in Spark a driver program is called an application rather than a job.</p><p>The last stage of a job generates the job&#x27;s result. For example in the <code>GroupByTest</code> in the first chapter, there&#x27;re 2 jobs with 2 sets of results. When a job is submitted, the <code>DAGScheduler</code> applies the strategy to figure out the stages, and submits firstly the <strong>stages without parents</strong> for execution. In this process, the number and type of tasks are also determined. A stage is executed after its parent stages&#x27; execution.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="details-in-job-submission">Details in Job Submission<a href="#details-in-job-submission" class="hash-link" aria-label="Direct link to Details in Job Submission" title="Direct link to Details in Job Submission">​</a></h2><p>Let&#x27;s briefly analyze the code for job creation and submission. We&#x27;ll come back to this part in the Architecture chapter.</p><ol><li><code>rdd.action()</code> calls <code>DAGScheduler.runJob(rdd, processPartition, resultHandler)</code> to create a job.</li><li><code>runJob()</code> gets the partition number and type of the final RDD by calling <code>rdd.getPartitions()</code>. Then it allocates <code>Array[Result](partitions.size)</code> for holding the results based on the partition number.</li><li>Finally <code>runJob(rdd, cleanedFunc, partitions, allowLocal, resultHandler)</code> in <code>DAGScheduler</code> is called to submit the job. <code>cleanedFunc</code> is the closure-cleaned version of <code>processPartition</code>. In this way this function can be serialized and sent to the different worker nodes.</li><li><code>DAGScheduler</code>&#x27;s <code>runJob()</code> calls <code>submitJob(rdd, func, partitions, allowLocal, resultHandler)</code> to submit a job.</li><li><code>submitJob()</code> gets a <code>jobId</code>, then wrap the function once again and send a <code>JobSubmitted</code> message to <code>DAGSchedulerEventProcessActor</code>. Upon receiving this message, the actor calls <code>dagScheduler.handleJobSubmitted()</code> to handle the submitted job. This is an example of event-driven programming model.</li><li><code>handleJobSubmitted()</code> firstly calls <code>finalStage = newStage()</code> to create stages, then it <code>submitStage(finalStage)</code>. If <code>finalStage</code> has parents, the parent stages will be submitted first. In this case, <code>finalStage</code> is actually submitted by <code>submitWaitingStages()</code>.</li></ol><p>How <code>newStage()</code> divide an RDD chain in stages?</p><ul><li>This method calls <code>getParentStages()</code> of the final RDD when instantiating a new stage (<code>new Stage(...)</code>)</li><li><code>getParentStages()</code> starts from the final RDD, check backwards the logical plan. It adds the RDD into the current stage if it&#x27;s a <code>NarrowDependency</code>. When it meets a <code>ShuffleDependency</code> between RDDs, it takes in the right-side RDD (the RDD after the shuffle) and then concludes the current stage. Then the same logic is applied on the left hand side RDD of the shuffle to form another stage.</li><li>Once a <code>ShuffleMapStage</code> is created, its last RDD will be registered <code>MapOutputTrackerMaster.registerShuffle(shuffleDep.shuffleId, rdd.partitions.size)</code>. This is important since the shuffle process needs to know the data output location from <code>MapOuputTrackerMaster</code>.</li></ul><p>Now let&#x27;s see how <code>submitStage(stage)</code> submits stages and tasks:</p><ol><li><code>getMissingParentStages(stage)</code> is called to determine the <code>missingParentStages</code> of the current stage. If the parent stages are all executed, <code>missingParentStages</code> will be empty.</li><li>If <code>missingParentStages</code> is not empty, then recursively submit these missing stages, and the current stage is inserted into <code>waitingStages</code>. Once the parent stages are done, stages inside <code>waitingStages</code> will be run.</li><li>if <code>missingParentStages</code> is empty, then we know the stage can be executed right now. Then <code>submitMissingTasks(stage, jobId)</code> is called to generate and submit the actual tasks. If the stage is a <code>ShuffleMapStage</code>, then we&#x27;ll allocate as many <code>ShuffleMapTask</code> as the partition number in the final RDD. In the case of <code>ResultStage</code>, <code>ResultTask</code> instances are allocated instead. The tasks in a stage form a <code>TaskSet</code>. Finally <code>taskScheduler.submitTasks(taskSet)</code> is called to submit the whole task set.</li><li>The type of <code>taskScheduler</code> is <code>TaskSchedulerImpl</code>. In <code>submitTasks()</code>, each <code>taskSet</code> gets wrapped in a <code>manager</code> variable of type <code>TaskSetManager</code>, then we pass it to <code>schedulableBuilder.addTaskSetManager(manager)</code>. <code>schedulableBuilder</code> could be <code>FIFOSchedulableBuilder</code> or <code>FairSchedulableBuilder</code>, depending on the configuration. The last step of <code>submitTasks()</code> is to inform <code>backend.reviveOffers()</code> to run the task. The type of backend is <code>SchedulerBackend</code>. If the application is run on a cluster, its type will be <code>SparkDeploySchedulerBackend</code>.</li><li><code>SparkDeploySchedulerBackend</code> is a subclass of <code>CoarseGrainedSchedulerBackend</code>, <code>backend.reviveOffers()</code> actually sends <code>ReviveOffers</code> message to <code>DriverActor</code>. <code>SparkDeploySchedulerBackend</code> launches a <code>DriverActor</code> when it starts. Once <code>DriverActor</code> receives the <code>ReviveOffers</code> message, it will call <code>launchTasks(scheduler.resourceOffers(Seq(new WorkerOffer(executorId, executorHost(executorId), freeCores(executorId)))))</code> to launch the tasks. <code>scheduler.resourceOffers()</code> obtains the sorted <code>TaskSetManager</code> from the FIFO or Fair scheduler and gethers other information about the tasks from <code>TaskSchedulerImpl.resourceOffer()</code>. These information are stored in a <code>TaskDescription</code>. In this step the data locality information is also considered.</li><li><code>launchTasks()</code> in the <code>DriverActor</code> serialize each task. If the serialized size does not exceed the <code>akkaFrameSize</code> limit of Akka, then the task is finally sent to the executor for execution: <code>executorActor(task.executorId) ! LaunchTask(new SerializableBuffer(serializedTask))</code>.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="discussion">Discussion<a href="#discussion" class="hash-link" aria-label="Direct link to Discussion" title="Direct link to Discussion">​</a></h2><p>Up till now, we&#x27;ve discussed:</p><ul><li>how the driver program triggers jobs</li><li>how to generate a physical plan from a logical plan</li><li>what is pipelining in Spark and how it is implemented</li><li>the actual code of job creation and submission</li></ul><p>However, there&#x27;s subjects that we&#x27;ve left for details:</p><ul><li>the shuffle process</li><li>task execution and its execution location</li></ul><p>In the next chapter we&#x27;ll discuss the shuffle process in Spark.</p><p>In my personal opinion, the transformation from logical plan to physical plan is really a masterpiece. The abstractions, such as dependencies, stages and tasks are all well defined and the logic of the algorithms are very clear.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="source-code-of-the-example-job">Source Code of the Example Job<a href="#source-code-of-the-example-job" class="hash-link" aria-label="Direct link to Source Code of the Example Job" title="Direct link to Source Code of the Example Job">​</a></h2><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">package</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">internals</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">org</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">apache</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">spark</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token plain">SparkContext</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">org</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">apache</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">spark</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token plain">SparkContext</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">import</span><span class="token plain"> </span><span class="token namespace" style="opacity:0.7">org</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">apache</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token namespace" style="opacity:0.7">spark</span><span class="token namespace punctuation" style="opacity:0.7;color:#393A34">.</span><span class="token plain">HashPartitioner</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">object</span><span class="token plain"> complexJob </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">args</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">[</span><span class="token builtin">String</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> sc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> SparkContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;local&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ComplexJob test&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> data1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">Int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">Char</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token char">&#x27;a&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token char">&#x27;b&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token char">&#x27;c&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token char">&#x27;d&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token char">&#x27;e&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token char">&#x27;f&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token char">&#x27;g&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token char">&#x27;h&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> rangePairs1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parallelize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> hashPairs1 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rangePairs1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">partitionBy</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> HashPartitioner</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> data2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">Int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">String</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;A&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;B&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;C&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;D&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> pairs2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parallelize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> rangePairs2 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> pairs2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">_2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">charAt</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> data3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token builtin">Int</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">Char</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token char">&#x27;X&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token char">&#x27;Y&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> rangePairs3 </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> sc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">parallelize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">data3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> rangePairs </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> rangePairs2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">union</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rangePairs3</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> hashPairs1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">join</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rangePairs</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">foreachWith</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">x</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> i</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;[result &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;] &quot;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> x</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    println</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">toDebugString</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/overview">overview</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/spark-internals">spark-internals</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/spark-internals/plans/spark-logical-plan"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Spark Logical Plan</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/spark-internals/shuffle-details"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Shuffle Details</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#a-complex-logical-plan" class="table-of-contents__link toc-highlight">A Complex Logical Plan</a></li><li><a href="#execution-of-the-physical-plan" class="table-of-contents__link toc-highlight">Execution of the Physical Plan</a></li><li><a href="#job-creation" class="table-of-contents__link toc-highlight">Job Creation</a></li><li><a href="#details-in-job-submission" class="table-of-contents__link toc-highlight">Details in Job Submission</a></li><li><a href="#discussion" class="table-of-contents__link toc-highlight">Discussion</a></li><li><a href="#source-code-of-the-example-job" class="table-of-contents__link toc-highlight">Source Code of the Example Job</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://join.slack.com/t/sparkplusplus/shared_invite/zt-2ceryo2v8-rb6m5M0Bqq02n_KKjP6CvQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">Join our Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/sparkplusplus/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2024 SparkPlusPlus Inc All Rights Reserved target="_blank">Privacy Policy</div></div></div></footer></div>
<script src="/assets/js/runtime~main.3b17f140.js"></script>
<script src="/assets/js/main.7e55bda0.js"></script>
</body>
</html>