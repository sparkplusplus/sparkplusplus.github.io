<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-spark-internals/plans/catalyst-optimizer">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Catalyst Optimizer | SparkPlusPlus</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://sparkplusplus.github.io/spark-internals/plans/catalyst-optimizer"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Catalyst Optimizer | SparkPlusPlus"><meta data-rh="true" name="description" content="Prophecy deployment is flexible and supports multiple mechanisms"><meta data-rh="true" property="og:description" content="Prophecy deployment is flexible and supports multiple mechanisms"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://sparkplusplus.github.io/spark-internals/plans/catalyst-optimizer"><link data-rh="true" rel="alternate" href="https://sparkplusplus.github.io/spark-internals/plans/catalyst-optimizer" hreflang="en"><link data-rh="true" rel="alternate" href="https://sparkplusplus.github.io/spark-internals/plans/catalyst-optimizer" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://P8WC4Z2QXP-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="SparkPlusPlus" href="/opensearch.xml">


<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="/assets/css/styles.b22f5b3f.css">
<link rel="preload" href="/assets/js/runtime~main.04b7d1e0.js" as="script">
<link rel="preload" href="/assets/js/main.761aa7d1.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Logo.png" alt="SparkPlusPlus Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/Logo.png" alt="SparkPlusPlus Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a href="https://github.com/sparkplusplus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Home</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Spark Internals</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/spark-internals/">Spark Internals</a><button aria-label="Toggle the collapsible sidebar category &#x27;Spark Internals&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/spark-internals/plans/spark-logical-plan">Spark Planning</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/plans/spark-logical-plan">Spark Logical Plan</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/plans/spark-physical-plan">Spark Physical Plan</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/spark-internals/plans/catalyst-optimizer">Catalyst Optimizer</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/shuffle-details">Shuffle Details</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/cache-and-checkpoint">Cache And Checkpoint</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/broadcast">Broadcast</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/spark-internals/"><span itemprop="name">Spark Internals</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Spark Planning</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Catalyst Optimizer</span><meta itemprop="position" content="3"></li></ul></nav><div class="theme-doc-markdown markdown"><h1>What is Catalyst optimizer</h1><p>An optimizer that automatically finds out the most efficient plan to execute data operations specified in the user’s program.</p><p>It “translates” transformations used to build the Dataset to physical plan of execution. Thus, it’s similar to <a href="http://www.waitingforcode.com/apache-spark/directed-acyclic-graph-in-spark/read#dag_scheduler" target="_blank" rel="noopener noreferrer">DAG scheduler</a> used to create physical plan of execution of RDD.</p><p>It is precious to Dataset in terms of performance. Since it understands the structure of used data and operations made on it, the optimizer can make some decisions helping to reduce time execution</p><h1>How it works</h1><p>Let’s first understand the terminology used in understanding the optimizer</p><ul><li><strong>logical plan</strong> — series of algebraic or language constructs, as for example: <em>SELECT</em>, <em>GROUP BY</em> or <em>UNION</em> keywords in SQL. It’s usually represented as a tree where nodes are the constructs.</li><li><strong>physical plan</strong> — similar to logical because also represented as a tree. But the difference is that physical plan concerns low level operations.</li><li><strong>unoptimized/optimized plans</strong> — a plan is considered as unoptimized when optimizer hasn’t worked on it yet. The plan becomes optimized when optimizer passed on it and made some optimizations (e.g.: merging <strong>filter()</strong> methods, replacing some instructions by another ones, most performant).</li></ul><p>So, it helps to move from unoptimized logical query plan to optimized physical plan, achieving that in below steps:</p><p><img loading="lazy" alt="how_it_works.png" src="/assets/images/how_it_works-9c2a33eefb4703bc76102316885de269.png" width="1286" height="649" class="img_ev3q"></p><ol><li>Optimizer tries to optimize logical query plan through predefined rule-based optimizations. The optimization can consists on:</li></ol><ul><li>predicate or projection pushdown — helps to eliminate data not respecting preconditions earlier in the computation.</li><li>rearrange filter</li><li>conversion of decimals operations to long integer operations</li><li>replacement of some RegEx expressions by Java’s methods startsWith(String) or contains(String)</li><li>if-else clauses simplification</li></ul><p>2<!-- -->.<!-- --> Optimized logical plan is created.</p><p>3<!-- -->.<!-- --> Optimizer constructs multiple physical plans from optimized logical plan. A physical plan defines how data will be computed. The plans are also optimized. The optimization can concern: merging different <strong>filter()</strong>, sending predicate/projection pushdown directly to datasource to eliminate some data at data source level.</p><p>4<!-- -->.<!-- --> Optimizer determines which physical plan has the lowest cost of execution and choses it as the physical plan used for the computation. CO also has a concept of metrics used to estimate the cost of plans.</p><p>5<!-- -->.<!-- --> Optimizer generates bytecode for the best physical plan. The generation is made thanks to Scala’s feature called <em>quasiquotes</em>. This step is optimized by <em>cost-based optimization</em></p><p>6<!-- -->.<!-- --> Once a physical plan is defined, it’s executed and retrieved data is put to Dataset.</p><h1>Example :</h1><p>Let’s understand how Catalyst optimizer works for a given query</p><h1>Trees</h1><p>A tree is the main data type in the catalyst. A tree contains node object. For each node, there is a node. A node can have one or more children. New nodes are defined as subclasses of TreeNode class. These objects are immutable in nature. The objects can be manipulated using functional transformation.</p><p><img loading="lazy" alt="1.png" src="/assets/images/1-872f00de84c5158b86471783c79772df.png" width="720" height="379" class="img_ev3q"></p><p><img loading="lazy" alt="2.png" src="/assets/images/2-71b45cdd27da326081552f32ce9f3af8.png" width="720" height="384" class="img_ev3q"></p><p><img loading="lazy" alt="3.png" src="/assets/images/3-c1761078bf36896346eefb53f9de79cf.png" width="720" height="379" class="img_ev3q"></p><p><img loading="lazy" alt="4.png" src="/assets/images/4-f740dc4d2af249bf2b3b119d21a19c1e.png" width="720" height="372" class="img_ev3q"></p><p><img loading="lazy" alt="5.png" src="/assets/images/5-ee4c2c47077396c18fc0e914713d79d8.png" width="720" height="357" class="img_ev3q"></p><p><img loading="lazy" alt="6.png" src="/assets/images/6-633a82de583b0ac89fcc41cd4c88c782.png" width="720" height="377" class="img_ev3q"></p><p><img loading="lazy" alt="7.png" src="/assets/images/7-92418a2183247ea519385ce8b63d062a.png" width="720" height="361" class="img_ev3q"></p><p><img loading="lazy" alt="8.png" src="/assets/images/8-76f90401cbfb08bccd4f9a9a10784a21.png" width="720" height="394" class="img_ev3q"></p><p><img loading="lazy" alt="9.png" src="/assets/images/9-92d5499e1161907cd59a0fb33081bbc2.png" width="720" height="383" class="img_ev3q"></p><p><img loading="lazy" alt="10.png" src="/assets/images/10-82d463a3861046006c8e814b4a5ab09a.png" width="720" height="393" class="img_ev3q"></p><p><img loading="lazy" alt="11.png" src="/assets/images/11-7dea02aa06d489c8b9a5c04435340425.png" width="720" height="397" class="img_ev3q"></p><p>By performing these transformations, the optimizer improves the execution times of relational queries and frees the developer from focusing on the semantics of their application instead of its performance.</p><p>Catalyst makes use of Scala’s powerful features such as pattern matching and runtime metaprogramming to allow developers to concisely specify complex relational optimizations.**</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/overview">overview</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/spark-internals">spark-internals</a></li></ul></div></div><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/sparkplusplus/sparkplusplus.github.io/edit/main/docs/spark-internals/plans/CatalystOptimizer.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/spark-internals/plans/spark-physical-plan"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Spark Physical Plan</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/spark-internals/shuffle-details"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Shuffle Details</div></a></nav></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://join.slack.com/t/sparkplusplus/shared_invite/zt-2ceryo2v8-rb6m5M0Bqq02n_KKjP6CvQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">Join our Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/sparkplusplus/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div></div></footer></div>
<script src="/assets/js/runtime~main.04b7d1e0.js"></script>
<script src="/assets/js/main.761aa7d1.js"></script>
</body>
</html>