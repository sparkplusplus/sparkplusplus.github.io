<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-spark-internals/architecture">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v2.3.1">
<title data-rh="true">Architecture | SparkPlusPlus</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://sparkplusplus.github.io/spark-internals/architecture"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Architecture | SparkPlusPlus"><meta data-rh="true" name="description" content="Prophecy deployment is flexible and supports multiple mechanisms"><meta data-rh="true" property="og:description" content="Prophecy deployment is flexible and supports multiple mechanisms"><link data-rh="true" rel="icon" href="/img/favicon.png"><link data-rh="true" rel="canonical" href="https://sparkplusplus.github.io/spark-internals/architecture"><link data-rh="true" rel="alternate" href="https://sparkplusplus.github.io/spark-internals/architecture" hreflang="en"><link data-rh="true" rel="alternate" href="https://sparkplusplus.github.io/spark-internals/architecture" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://ZWUSSL-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="SparkPlusPlus" href="/opensearch.xml">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><link rel="stylesheet" href="/assets/css/styles.b22f5b3f.css">
<link rel="preload" href="/assets/js/runtime~main.3b17f140.js" as="script">
<link rel="preload" href="/assets/js/main.ed3b454b.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/Logo.png" alt="SparkPlusPlus Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/img/Logo.png" alt="SparkPlusPlus Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div><b class="navbar__title text--truncate"></b></a><a href="https://github.com/sparkplusplus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Home</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/">Spark Internals</a></div><div class="navbar__items navbar__items--right"><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebarViewport_Xe31"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/">Intro</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/spark-internals/">Spark Internals</a><button aria-label="Toggle the collapsible sidebar category &#x27;Spark Internals&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/spark-internals/plans/spark-logical-plan">Spark Planning</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/shuffle-details">Shuffle Details</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/spark-internals/architecture">Architecture</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/cache-and-checkpoint">Cache And Checkpoint</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/spark-internals/broadcast">Broadcast</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/spark-internals/"><span itemprop="name">Spark Internals</span></a><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Architecture</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Architecture</h1></header><p>We talked about spark jobs in chapter 3. In this chapter, we will talk about the architecture and how master, worker, driver and executors are coordinated to finish a job.</p><div class="theme-admonition theme-admonition-tip alert alert--success admonition_LlT9"><div class="admonitionHeading_tbUL"><span class="admonitionIcon_kALy"><svg viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</div><div class="admonitionContent_S0QG"><p>Feel free to <strong>skip</strong> code if you prefer diagrams.</p></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="deployment-diagram">Deployment diagram<a href="#deployment-diagram" class="hash-link" aria-label="Direct link to Deployment diagram" title="Direct link to Deployment diagram">​</a></h2><p>We have seen the following diagram in <code>overview</code> chapter.</p><p><img loading="lazy" alt="deploy" src="/assets/images/deploy-d09ea8cbea191b94ef3fa1a6947f82e0.png" width="3012" height="2374" class="img_ev3q"></p><p>Next, we will talk about some details about it.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="job-submission">Job submission<a href="#job-submission" class="hash-link" aria-label="Direct link to Job submission" title="Direct link to Job submission">​</a></h2><p>The diagram below illustrates how driver program (on master node) produces job, and then submits it to worker nodes.</p><p><img loading="lazy" alt="JobSubmission" src="/assets/images/JobSubmission-fd28d6e7596241205fd910041721be5e.png" width="3049" height="2449" class="img_ev3q"></p><p>Driver side behavior is equivalent to the code below:</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">finalRDD</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">action</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> sc</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">runJob</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// generate job, stages and tasks</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> dagScheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">runJob</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> dagScheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">submitJob</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain">   dagSchedulerEventProcessActor </span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> JobSubmitted</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> dagSchedulerEventProcessActor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">JobSubmitted</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> dagScheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">handleJobSubmitted</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> finalStage </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> newStage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain">   mapOutputTracker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">registerShuffle</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shuffleId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rdd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">partitions</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> dagScheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">submitStage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain">   missingStages </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> dagScheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getMissingParentStages</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> dagScheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">subMissingTasks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">readyStage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// add tasks to the taskScheduler</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> taskScheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">submitTasks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> TaskSet</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tasks</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> fifoSchedulableBuilder</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addTaskSetManager</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskSet</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// send tasks</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> sparkDeploySchedulerBackend</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">reviveOffers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> driverActor </span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> ReviveOffers</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> sparkDeploySchedulerBackend</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">makeOffers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> sparkDeploySchedulerBackend</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">launchTasks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> foreach task</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      CoarseGrainedExecutorBackend</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">executorId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> LaunchTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">serializedTask</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Explanation:</p><p>When the following code is evaluated, the program will launch a bunch of driver communications, e.g. job&#x27;s executors, threads, actors, etc. </p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">val</span><span class="token plain"> sc </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> SparkContext</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">sparkConf</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>This line defines the role of driver</strong></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="job-logical-plan">Job logical plan<a href="#job-logical-plan" class="hash-link" aria-label="Direct link to Job logical plan" title="Direct link to Job logical plan">​</a></h3><p><code>transformation()</code> in driver program builds a computing chain (a series of <code>RDD</code>). In each <code>RDD</code>:</p><ul><li><code>compute()</code> function defines the computation of records for its partitions</li><li><code>getDependencies()</code> function defines the dependency relationship across RDD partitions.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="job-physical-plan">Job physical plan<a href="#job-physical-plan" class="hash-link" aria-label="Direct link to Job physical plan" title="Direct link to Job physical plan">​</a></h3><p>Each <code>action()</code> triggers a job:</p><ul><li>During <code>dagScheduler.runJob()</code>, different stages are defined</li><li>During <code>submitStage()</code>, <code>ResultTasks</code> and <code>ShuffleMapTasks</code> needed by the stage are produced, then they are packaged in <code>TaskSet</code> and sent to <code>TaskScheduler</code>. If <code>TaskSet</code> can be executed, tasks will be submitted to <code>sparkDeploySchedulerBackend</code> which will distribute tasks.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="task-distribution">Task distribution<a href="#task-distribution" class="hash-link" aria-label="Direct link to Task distribution" title="Direct link to Task distribution">​</a></h3><p>After <code>sparkDeploySchedulerBackend</code> gets <code>TaskSet</code>, the <code>Driver Actor</code> sends serialized tasks to <code>CoarseGrainedExecutorBackend Actor</code> on worker node.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="job-reception">Job reception<a href="#job-reception" class="hash-link" aria-label="Direct link to Job reception" title="Direct link to Job reception">​</a></h2><p>After receiving tasks, worker will do the following things:</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">coarseGrainedExecutorBackend </span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> LaunchTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">serializedTask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> executor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">launchTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> executor</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">threadPool</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">execute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> TaskRunner</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> serializedTask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>Executor packages each task into <code>taskRunner</code>, and picks a free thread to run the task. A <code>CoarseGrainedExecutorBackend</code> process has exactly one executor</strong></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="task-execution">Task execution<a href="#task-execution" class="hash-link" aria-label="Direct link to Task execution" title="Direct link to Task execution">​</a></h2><p>The diagram below shows the execution of a task received by worker node and how driver processes task results.</p><p><img loading="lazy" alt="TaskExecution" src="/assets/images/taskexecution-20da904f8b9d8b468969af86ecc89eee.png" width="3424" height="3729" class="img_ev3q"></p><p>After receiving a serialized task, the executor deserializes it into a normal task, and then runs the task to get <code>directResult</code> which will be sent back to driver. It is noteworthy that data package sent from <code>Actor</code> can not be too big:</p><ul><li>If the result is too big (e.g. the one of <code>groupByKey</code>), it will be persisted to &quot;memory + hard disk&quot; and managed by <code>blockManager</code>. Driver will only get <code>indirectResult</code> containing the storage location. When result is needed, driver will fetch it via HTTP.</li><li>If the result is not too big (less than <code>spark.akka.frameSize = 10MB</code>), then it will be directly sent to driver.</li></ul><p><strong>Some more details about <code>blockManager</code>:</strong></p><p>When <code>directResult &gt; akka.frameSize</code>, the <code>memoryStore</code> of <code>BlockManager</code> creates a <code>LinkedHashMap</code> to hold the data stored in memory whose size should be less than <code>Runtime.getRuntime.maxMemory * spark.storage.memoryFraction(default 0.6)</code>. If <code>LinkedHashMap</code> has no space to save the incoming data, these data will be sent to <code>diskStore</code> which persists data to hard disk if the data <code>storageLevel</code> contains &quot;disk&quot;</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">In TaskRunner</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// deserialize task, run it and then send the result to </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> coarseGrainedExecutorBackend</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">statusUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> task </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ser</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">deserialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">serializedTask</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> value </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> task</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> directResult </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> DirectTaskResult</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">ser</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"> directResult</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> akkaFrameSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       indirectResult </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> blockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">putBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> directResult</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> MEMORY</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">DISK</span><span class="token operator" style="color:#393A34">+</span><span class="token plain">SER</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> directResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> coarseGrainedExecutorBackend</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">statusUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> driver </span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> StatusUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">executorId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> taskId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The results produced by <code>ShuffleMapTask</code> and <code>ResultTask</code> are different.</p><ul><li><p><code>ShuffleMapTask</code> produces <code>MapStatus</code> containing 2 parts:</p><ul><li>the <code>BlockManagerId</code> of the task&#x27;s <code>BlockManager</code>: (executorId + host, port, nettyPort）</li><li>the size of each output <code>FileSegment</code> of a task</li></ul></li><li><p><code>ResultTask</code> produces the execution result of the specified <code>function</code> on one partition
e.g. The <code>function</code> of <code>count()</code> is simply for counting the number of records in a partition. Since <code>ShuffleMapTask</code> needs <code>FileSegment</code> for writing to disk, <code>OutputStream</code> writers are needed. These writers are produced and managed by <code>blockManger</code> of <code>shuffleBlockManager</code></p></li></ul><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">In task</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// if the task is ShuffleMapTask</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> shuffleMapTask</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">runTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> shuffleWriterGroup </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> shuffleBlockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">forMapTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shuffleId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> partitionId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> numOutputSplits</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> shuffleWriterGroup</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">writers</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bucketId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">write</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">rdd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">iterator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">split</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> MapStatus</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">blockManagerId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">compressedSize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fileSegment</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">//If the task is ResultTask</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">return</span><span class="token plain"> func</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> rdd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">iterator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">split</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A series of operations will be executed after driver gets a task&#x27;s result:</p><p><code>TaskScheduler</code> will be notified that the task is finished, and its result will be processed: </p><ul><li>If it is <code>indirectResult</code>, <code>BlockManager.getRemotedBytes()</code> will be invoked to fetch actual results.<ul><li>If it is <code>ResultTask</code>, <code>ResultHandler()</code> invokes driver side computation on result (e.g. <code>count()</code> take <code>sum</code> operation on all ResultTask).</li><li>If it is <code>MapStatus</code> of <code>ShuffleMapTask</code>, then <code>MapStatus</code> will be put into <code>mapStatuses</code> of <code>mapOutputTrackerMaster</code>, which makes it more easy to be queried during reduce shuffle.</li></ul></li><li>If the received task on driver is the last task in the stage, then next stage will be submitted. If the stage is already the last one, <code>dagScheduler</code> will be informed that the job is finished.</li></ul><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">After driver receives StatusUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> taskScheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">statusUpdate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> state</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> taskResultGetter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">enqueueSuccessfulTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskSet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> result is IndirectResult</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      serializedTaskResult </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> blockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getRemoteBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">IndirectResult</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">blockId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> scheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">handleSuccessfulTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">taskSetManager</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> tid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> taskSetManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">handleSuccessfulTask</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> taskResult</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> dagScheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">taskEnded</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">value</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">accumUpdates</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> dagSchedulerEventProcessActor </span><span class="token operator" style="color:#393A34">!</span><span class="token plain"> CompletionEvent</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">result</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> accumUpdates</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> dagScheduler</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">handleTaskCompletion</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">completion</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> Accumulators</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">add</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">event</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">accumUpdates</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// If the finished task is ResultTask</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">job</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">numFinished </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> job</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">numPartitions</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      listenerBus</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">post</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">SparkListenerJobEnd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">job</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">jobId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> JobSucceeded</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> job</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">listener</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">taskSucceeded</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">outputId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain">    jobWaiter</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">taskSucceeded</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain">    resultHandler</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// If the finished task is ShuffleMapTask</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> stage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">addOutputLoc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">smt</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">partitionId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> status</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">all tasks in current stage have finished</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      mapOutputTrackerMaster</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">registerMapOutputs</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shuffleId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">MapStatus</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      mapStatuses</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shuffleId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Array</span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">MapStatus</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">++</span><span class="token plain"> statuses</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> submitStage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">stage</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="shuffle-read">Shuffle read<a href="#shuffle-read" class="hash-link" aria-label="Direct link to Shuffle read" title="Direct link to Shuffle read">​</a></h2><p>In the preceding paragraph, we talked about task execution and result processing, now we will talk about how reducer (tasks needs shuffle) gets the input data. The shuffle read part in last chapter has already talked about how reducer processes input data.</p><p><strong>How does reducer know where to fetch data ?</strong></p><p><img loading="lazy" alt="readMapStatus" src="/assets/images/readMapStatus-aefaf8abb90ec60d64847b86c4156c51.png" width="3612" height="2749" class="img_ev3q"></p><p>Reducer needs to know on which node the <code>FileSegments</code> produced by <code>ShuffleMapTask</code> of parent stage are. <strong>This kind of information is sent to driver’s <code>mapOutputTrackerMaster</code> when <code>ShuffleMapTask</code> is finished. The information is also stored in <code>mapStatuses: HashMap[stageId, Array[MapStatus]]</code></strong>. Given <code>stageId</code>, we can get<code>Array[MapStatus]</code> which contains information about <code>FileSegments</code> produced by <code>ShuffleMapTasks</code>. <code>Array(taskId)</code> contains the location(<code>blockManagerId</code>) and the size of each <code>FileSegment</code>.</p><p>When reducer need fetch input data, it will first invoke <code>blockStoreShuffleFetcher</code> to get input data’s location (<code>FileSegments</code>). <code>blockStoreShuffleFetcher</code> calls local <code>MapOutputTrackerWorker</code> to do the work. <code>MapOutputTrackerWorker</code> uses <code>mapOutputTrackerMasterActorRef</code> to communicate with <code>mapOutputTrackerMasterActor</code> in order to get <code>MapStatus</code>. <code>blockStoreShuffleFetcher</code> processes <code>MapStatus</code> and finds out where reducer should fetch <code>FileSegment</code> information, and then it stores this information in <code>blocksByAddress</code>. <code>blockStoreShuffleFetcher</code> tells <code>basicBlockFetcherIterator</code> to fetch <code>FileSegment</code> data.</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">rdd</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">iterator</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> rdd</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">e</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">g</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ShuffledRDD</span><span class="token operator" style="color:#393A34">/</span><span class="token plain">CoGroupedRDD</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">compute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> SparkEnv</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">get</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">shuffleFetcher</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shuffledId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> split</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">index</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> ser</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> blockStoreShuffleFetcher</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">fetch</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shuffleId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reduceId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> context</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> serializer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> statuses </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> MapOutputTrackerWorker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getServerStatuses</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">shuffleId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> reduceId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> blocksByAddress</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> Seq</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BlockManagerId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> Seq</span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">BlockId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token builtin">Long</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> compute</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">statuses</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> basicBlockFetcherIterator </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> blockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getMultiple</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blocksByAddress</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> serializer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> itr </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> basicBlockFetcherIterator</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">flatMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">unpackBlock</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><img loading="lazy" alt="blocksByAddress" src="/assets/images/blocksByAddress-cfff353add27bebfabc52a61a08c8a29.png" width="3379" height="4524" class="img_ev3q"></p><p>After <code>basicBlockFetcherIterator</code> has received the task of data retrieving, it produces several <code>fetchRequest</code>s. <strong>Each of them contains the tasks to fetch <code>FileSegment</code>s from several nodes. </strong>According to the diagram above, we know that <code>reducer-2</code> needs to fetch <code>FileSegment</code>(FS)(in white) from 3 worker nodes. The global data fetching task can be represented by <code>blockByAddress</code>: 4 blocks from node 1, 3 blocks from node 2, and 4 blocks from node 3</p><p>In order to accelerate data fetching process, it makes sense to divide the global tasks into sub tasks(<code>fetchRequest</code>), then every task takes a thread to fetch data. Spark launches 5 parallel threads for each reducer (the same as Hadoop). Since the fetched data will be buffered into memory, one fetch is not able to take too much data (no more than <code>spark.reducer.maxMbInFlight＝48MB</code>). <strong>Note that <code>48MB</code> is shared by the 5 fetch threads,</strong> so each sub task should take no more than <code>48MB / 5 = 9.6MB</code>. In the diagram, on node 1, we have <code>size(FS0-2) + size(FS1-2) &lt; 9.6MB, but size(FS0-2) + size(FS1-2) + size(FS2-2) &gt; 9.6MB</code>, so we should break between <code>t1-r2</code> and <code>t2-r2</code>. As a result, we can see 2 <code>fetchRequest</code>s fetching data from node 1. <strong>Will there be <code>fetchRequest</code> larger than 9.6MB?</strong> The answer is yes. If one <code>FileSegment</code> is too large, it still needs to be fetched in one shot. Besides, if reducer needs some <code>FileSegment</code>s already existing on the local, it will do local read. At the end of shuffle read, it will deserialize fetched <code>FileSegment</code> and offer record iterators to <code>RDD.compute()</code></p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">In basicBlockFetcherIterator</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// generate the fetch requests</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> basicBlockFetcherIterator</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">initialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> remoteRequests </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> splitLocalRemoteBlocks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> fetchRequests </span><span class="token operator" style="color:#393A34">++</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> Utils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">randomize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">remoteRequests</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// fetch remote blocks</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> sendRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fetchRequests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dequeue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> until Size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fetchRequests</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> maxBytesInFlight</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> blockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">connectionManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">sendMessageReliably</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cmId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       blockMessageArray</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">toBufferMessage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> fetchResults</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> FetchResult</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> sizeMap</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> dataDeserialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> blockMessage</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getData</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> serializer</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// fetch local blocks</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> getLocalBlocks</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> fetchResults</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">put</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"> FetchResult</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> iter</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Some more details:</p><p><strong>How does the reducer send <code>fetchRequest</code> to the target node? How does the target node process <code>fetchRequest</code>, read and send back <code>FileSegment</code> to reducer?</strong></p><p><img loading="lazy" alt="fetchrequest" src="/assets/images/fetchrequest-3188c8a2e7e0a8ab2262f8907817be67.png" width="3287" height="3549" class="img_ev3q"></p><p>When <code>RDD.iterator()</code> meets <code>ShuffleDependency</code>, <code>BasicBlockFetcherIterator</code> will be called to fetch <code>FileSegment</code>s. <code>BasicBlockFetcherIterator</code> uses <code>connectionManager</code> of <code>blockManger</code> to send <code>fetchRequest</code> to <code>connectionManager</code>s on the other nodes. NIO is used for communication between <code>connectionManager</code>s. On the other nodes, for example, after <code>connectionManager</code> on worker node 2 receives a message, it will forward the message to <code>blockManager</code>. The latter uses <code>diskStore</code> to read <code>FileSegment</code>s requested by <code>fetchRequest</code> locally, they will still be sent back by <code>connectionManager</code>. If <code>FileConsolidation</code> is activated, <code>diskStore</code> needs the location of <code>blockId</code> given by <code>shuffleBolockManager</code>. If <code>FileSegment</code> is no more than <code>spark.storage.memoryMapThreshold = 8KB</code>, then diskStore will put <code>FileSegment</code> into memory when reading it, otherwise, The memory mapping method in <code>FileChannel</code> of <code>RandomAccessFile</code> will be used to read <code>FileSegment</code>, thus large <code>FileSegment</code> can be loaded into memory.</p><p>When <code>BasicBlockFetcherIterator</code> receives serialized <code>FileSegments</code> from the other nodes, it will deserialize and put them in <code>fetchResults.Queue</code>. You may notice that <strong><code>fetchResults.Queue</code> is similar to <code>softBuffer</code> in <code>Shuffle detials</code> chapter.</strong> If the <code>FileSegment</code>s needed by <code>BasicBlockFetcherIterator</code> are local, they will be found locally by <code>diskStore</code>, and put in <code>fetchResults</code>. Finally, reducer reads the records from <code>FileSegment</code> and processes them.</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">After the blockManager receives the fetch request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> connectionManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">receiveMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bufferMessage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> handleMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">connectionManagerId</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> message</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> connection</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// invoke blockManagerWorker to read the block (FileSegment)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> blockManagerWorker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">onBlockMessageReceive</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> blockManagerWorker</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">processBlockMessage</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockMessage</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> buffer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> blockManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getLocalBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> buffer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> diskStore</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getBytes</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> fileSegment </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> diskManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getBlockLocation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">blockId</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> shuffleManager</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">getBlockLocation</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">if</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fileSegment </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> minMemoryMapBytes</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     buffer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> ByteBuffer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">allocate</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fileSegment</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   </span><span class="token keyword" style="color:#00009f">else</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     channel</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">map</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">MapMode</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">READ_ONLY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> segment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">offset</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> segment</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">length</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Every reducer has a <code>BasicBlockFetcherIterator</code>, and one <code>BasicBlockFetcherIterator</code> could, in theory, hold 48MB of <code>fetchResults</code>. As soon as one <code>FileSegment</code> in <code>fetchResults</code> is read off, some <code>FileSegment</code>s will be fetched to fill that 48MB.</p><div class="language-scala codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-scala codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">BasicBlockFetcherIterator</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">next</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> result </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> results</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">task</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">while</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">!</span><span class="token plain">fetchRequests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">isEmpty </span><span class="token operator" style="color:#393A34">&amp;&amp;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bytesInFlight </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> bytesInFlight </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> fetchRequests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">front</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">size </span><span class="token operator" style="color:#393A34">&lt;=</span><span class="token plain"> maxBytesInFlight</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        sendRequest</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">fetchRequests</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">dequeue</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">=&gt;</span><span class="token plain"> result</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">deserialize</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="discussion">Discussion<a href="#discussion" class="hash-link" aria-label="Direct link to Discussion" title="Direct link to Discussion">​</a></h2><p>In terms of architecture design, functionalities and modules are pretty independent. <code>BlockManager</code> is well designed, but it seems to manage too many things (data block, memory, disk and network communication)</p><p>This chapter discussed how the modules of spark system are coordinated to finish a job (production, submission, execution, results collection, results computation and shuffle). A lot of code is pasted, many diagrams are drawn. More details can be found in source code, if you want.</p><p>If you also want to know more about <code>blockManager</code>, please refer to Jerry Shao&#x27;s <a href="http://jerryshao.me/architecture/2013/10/08/spark-storage-module-analysis/" target="_blank" rel="noopener noreferrer">blog</a> (in Chinese).</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-tags-row row margin-bottom--sm"><div class="col"><b>Tags:</b><ul class="tags_jXut padding--none margin-left--sm"><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/overview">overview</a></li><li class="tag_QGVx"><a class="tag_zVej tagRegular_sFm0" href="/tags/spark-internals">spark-internals</a></li></ul></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/spark-internals/shuffle-details"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Shuffle Details</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/spark-internals/cache-and-checkpoint"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Cache And Checkpoint</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#deployment-diagram" class="table-of-contents__link toc-highlight">Deployment diagram</a></li><li><a href="#job-submission" class="table-of-contents__link toc-highlight">Job submission</a><ul><li><a href="#job-logical-plan" class="table-of-contents__link toc-highlight">Job logical plan</a></li><li><a href="#job-physical-plan" class="table-of-contents__link toc-highlight">Job physical plan</a></li><li><a href="#task-distribution" class="table-of-contents__link toc-highlight">Task distribution</a></li></ul></li><li><a href="#job-reception" class="table-of-contents__link toc-highlight">Job reception</a></li><li><a href="#task-execution" class="table-of-contents__link toc-highlight">Task execution</a></li><li><a href="#shuffle-read" class="table-of-contents__link toc-highlight">Shuffle read</a></li><li><a href="#discussion" class="table-of-contents__link toc-highlight">Discussion</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://join.slack.com/t/sparkplusplus/shared_invite/zt-2ceryo2v8-rb6m5M0Bqq02n_KKjP6CvQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">Join our Slack<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/sparkplusplus/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Github<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">© 2024 SparkPlusPlus Inc All Rights Reserved target="_blank">Privacy Policy</div></div></div></footer></div>
<script src="/assets/js/runtime~main.3b17f140.js"></script>
<script src="/assets/js/main.ed3b454b.js"></script>
</body>
</html>